# 2025-10-18 Devlog (Wave 1 Day 4)

## Highlights
- Fixed the Postgres coordinator loops so heartbeat and election workers respect the stop channel, allowing the kernel binary to claim leadership and persist `kernel_raft_state` as expected.
- Expanded the Phase 1 integration harness to launch real Postgres-backed kernel binaries, detect the active leader, and force a failover that validates follower promotion end to end.
- Captured Prometheus metrics during the failover run to assert `kernel_coordinator` counters stay available when leadership changes.
- Documented the new harness workflow and kernel build prerequisites so contributors can reproduce the cluster checks locally.

## Stream Updates
### Control Plane (CP)
- Yesterday: HTTP/gRPC coverage existed but depended on the in-memory follower stub for 503 assertions.
- Today: Harness now truncates control-plane tables between phases and reuses the seeded tenant after the kernel cluster check, ensuring quotas and HTTP flows stay deterministic alongside the new failover run.
- Risks / Blockers: Need to route leader metadata back into the policy layer once the command bus supports multi-kernel awareness (CP-POLICY-10).
- Telemetry Links: Review harness output for `HTTP` and `gRPC` checkpoints preceding the cluster logs.

### Horology Kernel (HK)
- Yesterday: Prometheus metrics existed but there was no automated validation of leadership transitions.
- Today: Patched the coordinator worker loops to tick independently of shutdown signals, enabling the binary to insert the initial leader row and refresh heartbeats; two kernel binaries (`kernel-a`, `kernel-b`) now start inside the harness, publish metrics to dedicated ports, and the script confirms a follower assumes leadership within 20s after the leader is terminated.
- Risks / Blockers: Need Grafana dashboards that consume the new counters and alert on repeated `not-leader` responses (HK-OBS-04).
- Telemetry Links: Harness logs include `kernel(...) stdout/stderr` entries plus the metrics scrape results (`Kernel metrics endpoint reachable`).

### Execution Mesh (EM)
- Yesterday: No direct changes.
- Today: Observed the gRPC + HTTP phases succeeding before the kernel cluster check, providing a baseline once JetStream-driven orchestrator validations land.
- Risks / Blockers: Still need leader-aware orchestrator consumers (EM-BUS-04) to honour failover semantics.
- Telemetry Links: _(pending orchestrator instrumentation)._ 

### Developer Experience (DX)
- Yesterday: Local environment guide highlighted follower simulation only.
- Today: Documented the multi-kernel harness run, emphasised the need to pre-build the kernel, and clarified the additional log output developers should expect.
- Risks / Blockers: CI harness integration still pending on containerised Postgres and cached kernel builds (DX-TEST-07).
- Telemetry Links: `docs/devx/LOCAL_ENVIRONMENT.md` now references the kernel cluster validation steps.

### Governance
- Yesterday: Leadership churn remained a manual check.
- Today: Failover validation ensures coordinator counters persist, giving the audit ledger team concrete metrics to tap once governance hooks ship.
- Risks / Blockers: Need to persist leadership transitions into the audit log (GOV-AUDIT-02) following the harness work.
- Telemetry Links: Prometheus scrape during harness run shows `kernel_coordinator.leadership.transitions` increments.

## Testing Summary
- ✅ command `node -r ts-node/register/transpile-only -r ./scripts/ts-node-preload.js tests/phase1/runHarness.ts`
- ✅ command `cargo test --manifest-path services/horology-kernel/Cargo.toml`
- ✅ command `npm test -- --passWithNoTests`
- ✅ command `npm run build`

## Decisions & Follow-ups
- Decision: Treat the harness-driven failover as the Wave 1 acceptance gate for Postgres leadership, requiring both scheduling success and metrics verification after follower promotion (owner: HK/DX pairing, logged 2025-10-18).
- Follow-up: Add Grafana dashboards (or Honeycomb boards) covering coordinator counters and failover latency, wiring alerts for repeated `not-leader` responses (owners: Observability guild, due 2025-10-24).
- Follow-up: Integrate the harness into CI with cached kernel builds and containerised Postgres once GitHub Actions resources are provisioned (owners: DX tooling squad, due 2025-10-25).
