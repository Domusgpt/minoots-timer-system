# 2025-10-16 Devlog (Wave 1 Day 2)

## Highlights
- Exercised the Postgres-backed leadership coordinator with deterministic Rust tests covering leader acquisition, shutdown, and follower failover behaviour.
- Surfaced kernel `FAILED_PRECONDITION` responses as HTTP 503 errors with retry hints, giving agents actionable feedback when the control plane targets a follower.
- Documented local procedures for simulating leader loss so DX can validate failover manually while OTEL instrumentation is still pending.

## Stream Updates
### Control Plane (CP)
- Yesterday: Kernel follower responses bubbled up as opaque 500 errors without retry guidance.
- Today: Added `KernelNotLeaderError` propagation, mapping gRPC status codes to HTTP 503 with optional `Retry-After` headers, and updated error handling in timer routes.
- Risks / Blockers: Integration harness still uses the in-memory gateway; needs upgrade to hit a live kernel replica to assert 503 propagation (story CP-POLICY-07).
- Telemetry Links: _(pending once OTEL spans are wired to the gateway middleware in Wave 1 observability work)._ 

### Horology Kernel (HK)
- Yesterday: Postgres coordinator shipped without automated regression coverage for failover edge cases.
- Today: Added async tests that validate leadership establishment, shutdown behaviour, and stale-heartbeat failover between two coordinators, ensuring `LeaderHandle` flips correctly.
- Risks / Blockers: Need OTEL span + metric export for election rounds (HK-RAFT-05) and to wire the integration harness against the real kernel runtime.
- Telemetry Links: Use `SELECT * FROM kernel_raft_state;` in Postgres after running tests to confirm leader state transitions.

### Execution Mesh (EM)
- Yesterday: No new work since JetStream DLQ tooling landed.
- Today: Observed kernel failover impact on orchestrator inputs; no code changes.
- Risks / Blockers: Awaiting leader-aware subscription logic before enabling multi-agent fan-out tests (EM-BUS-04).
- Telemetry Links: _(pending)_.

### Developer Experience (DX)
- Yesterday: Local environment guide lacked notes on follower responses.
- Today: Documented 503 semantics and retry hints in `docs/devx/LOCAL_ENVIRONMENT.md` so developers can reproduce failover scenarios locally.
- Risks / Blockers: Need to capture OTEL trace examples for coordinator elections once metrics land (DX-OBS-03).
- Telemetry Links: Manual Postgres inspection (`docker exec -it minoots-postgres psql ...`) to view `kernel_raft_state` updates.

### Governance
- Yesterday: Awaiting follower/audit trail plan.
- Today: No direct changes; error propagation groundwork sets up future audit logging of failover events.
- Risks / Blockers: Must log follower rejections in audit ledger once observability spine is wired (GOV-AUDIT-02).
- Telemetry Links: _(pending)_.

## Testing Summary
- ✅ command `cargo test --manifest-path services/horology-kernel/Cargo.toml`
- ✅ command `npm test`
- ✅ command `npm run build`

## Decisions & Follow-ups
- Follow-up: Upgrade integration harness to run against a live kernel replica and assert `503` behaviour (owner: DX/CP pairing, due: 2025-10-20).
- Follow-up: Emit OTEL spans for election rounds and HTTP 503 responses to improve observability (owner: HK lead, due: 2025-10-23).
- Decision: Treat kernel follower responses as retryable 503 with optional `Retry-After` hints for agent ergonomics (owner: CP lead, logged 2025-10-16).
