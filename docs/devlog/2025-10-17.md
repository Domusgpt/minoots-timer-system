# 2025-10-17 Devlog (Wave 1 Day 3)

## Highlights
- Wrapped the Postgres coordinator with OpenTelemetry tracing and Prometheus counters, exposing a `/metrics` endpoint from the kernel binary for election, heartbeat, and leadership telemetry.
- Normalised the gRPC gateway to load the shared proto from repo root, coerce `durationMs` payloads, and emit structured errors (including retry metadata) for follower responses.
- Updated the Phase 1 integration harness to simulate follower responses, execute real gRPC scheduling, and assert HTTP 503 propagation (with `Retry-After`) so control-plane regressions are caught automatically.
- Refreshed the local environment guide and `.env.example` with the new metrics address, OTEL overrides, and the harness invocation to help developers verify spans and scrape metrics locally.

## Stream Updates
### Control Plane (CP)
- Yesterday: 503 propagation existed but lacked automated coverage.
- Today: Harness now spins up a follower gateway stub to validate the HTTP surface, ensures the gRPC gateway parses numeric `durationMs` values correctly, and maps `KernelNotLeaderError` to `FAILED_PRECONDITION` with retry metadata.
- Risks / Blockers: Need a multi-kernel harness wired to live gRPC endpoints before closing Wave 1 (story CP-POLICY-09).
- Telemetry Links: Check `node tests/phase1/runHarness.ts` output for follower validation logs.

### Horology Kernel (HK)
- Yesterday: Coordinators emitted tracing logs only; no structured telemetry or metrics.
- Today: Added spans (`coordinator.election_round`, `coordinator.heartbeat`, `coordinator.takeover`) and Prometheus counters for election attempts/results, heartbeats, and leadership transitions; metrics served via `KERNEL_METRICS_ADDR` and wired into the new `/metrics` endpoint served by the telemetry module.
- Risks / Blockers: Need Grafana dashboards and alerting hooks once OTEL Collector exporters are wired (HK-OBS-04).
- Telemetry Links: `curl http://localhost:9464/metrics | grep kernel_coordinator` after running the kernel.

### Execution Mesh (EM)
- Yesterday: No changes.
- Today: Observed follower error coverage through the control plane harness; no direct code changes.
- Risks / Blockers: Awaiting leader-aware subscription logic (EM-BUS-04).
- Telemetry Links: _(pending once orchestrator spans land)._ 

### Developer Experience (DX)
- Yesterday: Docs described follower semantics but not telemetry setup.
- Today: Documented metrics scraping workflow, OTEL overrides, and the harness command (with preload shim) in `docs/devx/LOCAL_ENVIRONMENT.md` and `.env.example`.
- Risks / Blockers: Need an end-to-end demo showing metrics ingestion into Grafana before Wave 1 sign-off (DX-OBS-05).
- Telemetry Links: Local metrics verification snippet in the guide (`curl -s http://localhost:9464/metrics | head`).

### Governance
- Yesterday: Pending audit hooks for leadership changes.
- Today: No direct governance work, but the new metrics counters provide inputs for future audit ledger entries.
- Risks / Blockers: Must persist leadership transitions to the audit log (GOV-AUDIT-02).
- Telemetry Links: Observe `kernel.coordinator.leadership.transitions` counter for churn analysis.

## Testing Summary
- ✅ command `cargo test --manifest-path services/horology-kernel/Cargo.toml`
- ✅ command `npm test`
- ✅ command `npm run build`
- ✅ command `node tests/phase1/runHarness.ts`

## Decisions & Follow-ups
- Decision: Publish kernel telemetry at `KERNEL_METRICS_ADDR` with Prometheus format while defaulting OTEL trace exporter to `OTEL_EXPORTER_OTLP_ENDPOINT` (owner: HK lead, logged 2025-10-17).
- Follow-up: Build a multi-kernel failover harness that boots two real kernel binaries and verifies end-to-end leadership transfer (owners: HK/DX pairing, due 2025-10-22).
- Follow-up: Produce Grafana dashboards (or Honeycomb boards) for the new coordinator metrics and wire alerts for repeated election errors (owner: Observability guild, due 2025-10-24).
